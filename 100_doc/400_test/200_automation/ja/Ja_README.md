# Tributary Test Automation

**更新日**: 2025-09-18
**更新者**: akameGusya

## 概要

Tributary CLI の包括的な自動テストシステムです。開発環境から本番環境まで、全機能の品質保証を自動化します。

## ⚠️ 事前準備要件と制限事項

### 🔧 ユーザーが準備する必要があるもの

#### 1. ソフトウェア要件
- **Node.js**: バージョン18.0以上
- **npm**: バージョン8.0以上
- **Git**: リポジトリ操作用
- **curl**: ネットワーク接続テスト用
- **オペレーティングシステム**: Windows 10+、macOS 10.15+、またはLinux（Ubuntu 18.04+）

#### 2. Solana環境セットアップ
- **Solana CLI**: インストールと設定が必要
- **ネットワークアクセス**: devnet/testnetへの安定したインターネット接続
- **RPCエンドポイント**: Solana devnetおよびtestnet RPCへのアクセス

#### 3. テスト用ウォレットとトークン（実配布テストのみ必要）
- **testnet SOL取得**: ⚠️ **重大な制限事項**
  - **Solanaフォーセット制限**: 公式フォーセットから8時間あたり最大5 SOL
  - **現実**: ❌ **頻繁に利用不可** - フォーセットが空または制限されることが多い
  - **必要残高**: 包括的な実配布テストには最低20 SOL必要
  - **準備時間**: ⚠️ **公開フォーセットから十分なtestnet SOLを蓄積することは不可能な場合が多い**

- **💡 推奨代替案: カスタムテストトークン**
  - **カスタムSPLトークン**: ✅ **推奨アプローチ** - 独自作成トークンを使用
  - **無制限供給**: テストに必要な分だけトークンを作成可能
  - **完全制御**: トークン配布とテストの完全制御
  - **現実的テスト**: 実際のSPLトークン転送機能をテスト
  - **コスト無し**: 限定されたフォーセットリソースに依存しない

- **管理者ウォレット**: 有効なSolanaキーペアファイル（トランザクション手数料用の少量SOL）
- **ネットワーク権限**: testnetでトランザクションを送信する能力
- **トークン設定**: ⚠️ **現在のテストはSOL用に設定されているが適応可能**
  - **カスタムトークン**: ✅ **簡単に設定可能** - テスト設定でトークンアドレスを更新
  - **USDT/USDC**: ❌ 現在のテスト実装では非対応
  - **トークン作成**: 一貫したテストのための専用テストトークン作成を推奨

#### 4. システムリソース
- **メモリ**: 最小2GB RAM（4GB推奨）
- **ディスク容量**: テスト成果物用に最小1GB空き容量
- **CPU**: 並列テスト実行のためマルチコアプロセッサ推奨

### 🚨 テストの制限事項と制約

#### 1. ネットワーク制限
- **mainnetテスト**: ❌ **絶対にテストしない** - 全テストはdevnet/testnetのみで実行
- **プライベートネットワーク**: ❌ カスタムSolanaネットワーク設定はテスト不可
- **オフラインモード**: ❌ ほとんどのテストでネットワーク接続が必要
- **レート制限**: 集中的なテスト中にRPCレート制限に遭遇する可能性

#### 2. トークンとウォレットの制限
- **実資産**: ❌ mainnetトークンは使用しない（testnetのみ）
- **トークンタイプ**: ⚠️ **制限事項**: 現在はSOL転送のテストのみ
  - ❌ **USDTテスト**: 現在のテストスイートでは未実装
  - ❌ **USDCテスト**: 現在のテストスイートでは未実装
  - ❌ **カスタムSPLトークン**: 標準SPLトークンテストのサポート限定
  - ❌ **NFTトークン**: NFT（Non-Fungible Token）テスト不可
- **ハードウェアウォレット**: ❌ Ledger/Trezor統合テスト不可
- **マルチシグウォレット**: ❌ マルチ署名ウォレットテスト非対応

#### 3. 機能制限
- **インタラクティブコマンド**: ⚠️ ユーザー入力プロンプトの自動化が限定的
- **GUIテスト**: ❌ CLIのみ - グラフィカルインターフェースのテスト不可
- **メール通知**: ❌ メール/SMS通知のテスト不可
- **外部統合**: ❌ サードパーティAPI統合はテスト対象外

#### 4. パフォーマンス制限
- **負荷テスト**: ⚠️ 中規模テストに限定（最大1000トランザクション）
- **ストレステスト**: ❌ 高負荷ストレステスト機能なし
- **同時ユーザー**: ❌ 単一ユーザー操作のテストのみ
- **長期安定性**: ❌ 長時間テスト（6時間超）なし

#### 5. セキュリティ制限
- **ペネトレーションテスト**: ❌ セキュリティ脆弱性スキャンなし
- **キー回復**: ❌ ウォレット回復シナリオテストなし
- **暗号化テスト**: ❌ 暗号化セキュリティ検証なし
- **アクセス制御**: ❌ ロールベースアクセス制御テストなし

### 📋 テスト実行前チェックリスト

包括的テスト実行前に以下を確認：

- [ ] **Tributary CLIインストール済み**: `tributary --version` が動作
- [ ] **ネットワーク接続**: devnet/testnetエンドポイントに到達可能
- [ ] **十分なディスク容量**: 最低1GB空き容量
- [ ] **依存関係インストール済み**: `npm install` が正常完了

#### 実配布テスト用（オプション）:
- [ ] **管理者ウォレット準備**: 有効なSolanaキーペアファイル
- [ ] **トークン選択決定**:
  - [ ] **選択肢A**: testnet SOLの取得を試行（フォーセット制限により不可能な場合が多い）
  - [ ] **選択肢B**: ✅ **推奨** - 独自作成のカスタムSPLトークンを使用
- [ ] **トークン設定**: カスタムトークンアドレスでテスト設定を更新
- [ ] **手数料用SOL**: トランザクション手数料用の少量SOL（0.1-0.5 SOLで十分）
- [ ] **環境変数**: テストディレクトリパスが設定済み

### 🚫 テストできないもの

#### 1. 本番環境操作
- **mainnetトランザクション**: 実際の本番トークン転送
- **生ユーザーデータ**: 実際のユーザーウォレット操作
- **本番API**: 実際の取引所やDeFiプロトコル統合
- **規制コンプライアンス**: 法的またはコンプライアンスワークフローのテスト

#### 1.5. トークン固有の制限
- **USDT配布**: ⚠️ **重要な制限** - 現在のテストスイートではUSDT転送をテストしない
- **USDC配布**: ⚠️ **重要な制限** - 現在のテストスイートではUSDC転送をテストしない
- **ステーブルコインテスト**: ❌ 包括的なステーブルコイン配布テストなし
- **トークンスワップ操作**: ❌ トークン交換やスワップ機能のテストなし
- **クロストークン操作**: ❌ マルチトークン配布シナリオのテストなし

#### 2. ハードウェア依存機能
- **ハードウェアウォレット**: Ledger、Trezor、または類似デバイス統合
- **モバイルデバイス**: スマートフォンやタブレットの互換性
- **特定ハードウェア**: プラットフォーム固有のハードウェア機能

#### 3. 外部サービス統合
- **メールサービス**: SMTPまたはメールプロバイダー統合
- **SMSサービス**: テキストメッセージ通知システム
- **クラウドストレージ**: AWS S3、Google Cloud、または類似統合
- **分析プラットフォーム**: サードパーティ分析または監視ツール

#### 4. 高度なSolana機能
- **プログラムデプロイ**: スマートコントラクトデプロイテスト
- **カスタム命令**: 非標準トランザクションタイプ
- **バリデーター操作**: ステーキング、委任、またはバリデーターセットアップ
- **ガバナンス**: DAO投票またはガバナンストークン操作

### ⚠️ 重要な警告

#### 実配布テスト
- **🚨 TESTNETのみ**: mainnetでは絶対に実行しない
- **💰 実トークン**: testnetでの実際のトークンを使用した実トランザクション
- **🔧 トークンオプション**:
  - **選択肢A**: testnet SOL（❌ **フォーセット制限により利用困難** - 頻繁に利用不可）
  - **選択肢B**: ✅ **推奨** - カスタムSPLトークン（無制限供給、完全制御）
- **⏰ 取り消し不可**: 一度実行されたトークン転送は元に戻せない
- **📊 範囲制限**:
  - **testnet SOL使用時**: 1テストセッションあたり最大5 SOL（取得可能な場合）
  - **カスタムトークン使用時**: 所有するトークン供給量に基づく無制限テスト範囲

#### テスト環境
- **🗑️ 一時ファイル**: テストでクリーンアップが必要な一時ファイルを作成
- **🌐 ネットワーク依存**: 安定したインターネット接続が必要
- **⚡ リソース集約的**: 実行中にCPU/メモリを大量消費する可能性
- **📝 ログファイル**: 機密情報を含む可能性のある詳細ログを生成

## テストスクリプト構成

### 🚀 メインテストランナー
- **test-runner.js** - フル機能テストスイート
- **ci-runner.js** - CI/CD環境向け最適化版
- **setup.js** - テスト環境セットアップ
- **cleanup.js** - テスト後のクリーンアップ

### 📋 実行フェーズ

#### Phase 1: devnet基本機能テスト (30分)
- プロジェクト初期化
- 設定管理
- エラーハンドリング
- 入力値検証

#### Phase 2: testnet統合テスト (2時間)
- トークン保有者収集
- 配布シミュレーション
- ドライラン実行
- 少額実配布

#### Phase 3: パフォーマンステスト (1時間)
- 大量データ処理
- メモリ使用量監視
- 実行時間測定

#### Phase 4: 本番準備テスト (30分)
- mainnet設定検証
- 本番用パラメータ確認

## 使用方法

### 1. 環境セットアップ

```bash
cd 400_test/200_automation
npm install
node setup.js
```

### 2. フルテスト実行

```bash
# 全フェーズ実行 (約4時間)
npm test

# 特定フェーズのみ
npm run test:devnet    # Phase 1のみ
npm run test:testnet   # Phase 2のみ
npm run test:performance  # Phase 3のみ
```

### 3. CI環境での実行

```bash
# CI最適化版 (約15分)
npm run test:ci
```

### 4. クリーンアップ

```bash
# 通常クリーンアップ
npm run cleanup

# 強制クリーンアップ
node cleanup.js --force
```

## 設定オプション

### テストランナー設定

```javascript
{
  devnetTimeout: 60000,     // devnetテストタイムアウト
  testnetTimeout: 300000,   // testnetテストタイムアウト
  maxRetries: 3,            // 最大リトライ回数
  skipRealDistribution: false,  // 実配布をスキップ
  skipInteractive: true     // インタラクティブモードをスキップ
}
```

### 環境変数

```bash
# テスト環境変数 (自動生成される)
source /tmp/tributary-test-setup/test.env

# 主要な変数
TRIBUTARY_TEST_DIR="/tmp/tributary-test-setup"
ADMIN_WALLET_PATH="/tmp/tributary-test-setup/wallets/admin-wallet.json"
DEVNET_CONFIG_PATH="/tmp/tributary-test-setup/configs/devnet-config.toml"
```

## 出力とレポート

### 実行結果

```
🚀 Tributary Automated Test Suite Starting...
📅 Start Time: 2025-09-18T10:00:00.000Z

🏁 Phase 1: devnet Basic Functions
🧪 Running T001: Basic initialization (attempt 1)
✅ T001 PASSED (1205ms)
...

========================================
📋 TEST EXECUTION SUMMARY
========================================
⏱️  Total Duration: 245s
📊 Total Tests: 25
✅ Passed: 23
❌ Failed: 2
⏭️  Skipped: 3
📈 Success Rate: 92.0%
📄 Report saved: /tmp/tributary-test-xxx/test-report.json
========================================
```

### 生成されるファイル

- **test-report.json** - 詳細テスト結果 (JSON)
- **ci-test-report.json** - CI用レポート
- **junit.xml** - JUnit形式のテスト結果
- **failure-report.json** - 失敗時の詳細情報

## GitHub Actions統合

### ワークフロー設定

```yaml
# .github/workflows/test.yml にコピー
name: Tributary Test Suite
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    # ... (詳細は github-workflow.yml 参照)
```

### 自動実行トリガー

- **Push**: main/developブランチへのプッシュ
- **Pull Request**: mainブランチへのPR
- **Schedule**: 毎日午前2時 (UTC)

## テスト項目詳細

### ✅ 実装済みテスト

| テストID | 項目名 | 優先度 | 実行時間 |
|---------|--------|-------|----------|
| T001 | 基本初期化 | 高 | ~1s |
| T002 | インタラクティブ初期化 | 高 | スキップ |
| T003 | 強制上書き | 中 | ~2s |
| T004 | 無効パラメータ | 高 | ~1s |
| T010 | トークン収集 | 高 | ~30s |
| T020 | 配布シミュレーション | 高 | ~15s |
| T030 | ドライラン | 高 | ~20s |
| T031 | 実配布 | 高 | スキップ* |
| T040 | 設定表示 | 高 | ~1s |
| T041 | 設定検証 | 高 | ~1s |
| T050 | ネットワークエラー | 中 | ~5s |
| T060 | 無効トークン | 高 | ~1s |
| T070 | パフォーマンス | 中 | ~60s |
| T090 | mainnet設定 | 高 | ~2s |

*実配布は安全のため自動テストではスキップ

### ❌ 未実装テスト (今後追加予定)

- T100-T102: 配布履歴機能
- T110-T112: ログ・監査機能
- T120-T122: 高度な出力形式
- T130-T131: ネットワーク切り替え
- T140-T142: 詳細エラーハンドリング

## トラブルシューティング

### よくあるエラー

#### 1. Tributary CLI not found
```bash
npm install -g @akamellc/tributary
# または
cd ../../200_src && npm link
```

#### 2. ネットワーク接続エラー
```bash
# 手動でネットワーク確認
curl -s https://api.devnet.solana.com -d '{"jsonrpc":"2.0","id":1,"method":"getHealth"}' -H "Content-Type: application/json"
```

#### 3. 権限エラー (Unix系)
```bash
chmod +x test-runner.js ci-runner.js setup.js cleanup.js
```

#### 4. テストタイムアウト
- ネットワークが遅い場合は設定でタイムアウト値を増加
- `config.devnetTimeout`, `config.testnetTimeout` を調整

### ログとデバッグ

```bash
# デバッグモードで実行
DEBUG=1 node test-runner.js

# 詳細ログを有効化
TRIBUTARY_LOG_LEVEL=debug node test-runner.js
```

## 性能基準

### 合格基準
- **成功率**: 95%以上
- **Phase 1実行時間**: 5分以内
- **Phase 2実行時間**: 2.5時間以内
- **メモリ使用量**: 1GB以内
- **エラー処理**: 100%

### ベンチマーク目標
- 1000ウォレット収集: 5分以内
- 100件配布シミュレーション: 30秒以内
- 設定検証: 1秒以内

## 貢献とメンテナンス

### テスト追加手順
1. `test-runner.js` に新しいテストメソッドを追加
2. 対応するフェーズにテストを登録
3. 期待値とエラーケースを定義
4. ドキュメントを更新

### CI/CD改善点
- testnet実行の最適化
- 並列実行の拡張
- セキュリティスキャンの強化
- パフォーマンス回帰テストの追加

---

**注意**: このテストスイートはdevnetとtestnetでのみ実行され、mainnetでの実行は行いません。本番環境での動作は手動検証が必要です。